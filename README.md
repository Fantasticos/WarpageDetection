# WarpageDetection
CMU CERLAB Pointcloud Team, Warpage detection for windows

## Overview
This is a research project in CERLAB CMU, sponsored by YKK AP Inc. The goal for this project is to inspect the installation of windows in the construction site.This research proposes a high-precision and automated inspection workflow using the point cloud generated by 360-degree Laser Scanners. The scanned point cloud is compared with a sample cloud generated from the 3D CAD model. The sample model is registered to the window scan using Boolean Map descriptors and [Iterative Closest Point (ICP)](https://en.wikipedia.org/wiki/Iterative_closest_point) algorithm to get its precise position and orientation. The point cloud is then segmented with a voxel grid, each voxel containing part of the window’s edge. By comparing the edge segments andthe ground truth in the CAD model, the warpage of the window frame is measured.

## Structure

**warp_detect**

```
├── CMakeLists.txt
├── data
│   ├── AW-1Z_without_noise_front.pcd
│   ├── AW-2Z_without_noise_front.pcd
│   ├── helios.ply
│   ├── pbm150.ply
│   └── triton.png
└── src
    ├── gasd.cpp
    ├── gldetect.cpp
    ├── gldetect.hpp
    ├── lineseg2d.h
    ├── main.cpp
    ├── registration.cpp
    ├── registration.hpp
    ├── testicp.h
    ├── visualize.h
    ├── warpage.cpp
    └── warpage.hpp
```

***src*** is a collection of headers and cpps.

***data*** is where the images and point clouds are placed.

**CUDA_ICP**

This is an experimental method to do ICP with CUDA, inspired by [CUDA-ScanMatcher-ICP](https://github.com/botforge/CUDA-ScanMatcher-ICP). To compile this code, just build and run in `./build`.

## Libraries

Some necessary libraries are needed to compile the *warp_detect*. One is point cloud library [PCL](https://pointclouds.org/), the other is [OpenCV](https://opencv.org/), follow the instructions on the website to install them. 

For *CUDA_ICP*, please install the necessary [CUDA package](https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html)

## Parameter explanation and how to run

To run the code, put a room scan cloud in `data`, make sure that the room is in meter, otherwise uncomment line 27 to 29 to do the scaling. Set the input room scan in *main.cpp* line 61, set the bounding boxes for windows in *main.cpp* line 69, set the type of window in *main.cpp* line 84.

In the `warp_detect` folder:

`mkdir build`

`cd build`

`cmake ..`

`make`

To run the executable, use:

`./warp_detect`

**Parameters**

There are several parameters need to tune in the following development:

In *registration.cpp*, line 161, *leaficp* is the downsample size of ICP, which is needed to be tuned, larger leaf size means faster speed and lower accuracy.

Line 174, the last three parameters of `testicp::icp` is 2000, 1e-8 and 0.9, which are the iteration limit, convergence error and overlapping rate.

In *warpage.cpp*, line 276, `getWarpage` function. Bounding boxes of 8 edges are manually set by 8 input to *min_pt* and *max_pt*. These parameters can be fine tuned to have better performance.

##Notice

There are several limitations for data also:

1. Currently all the windows should be facing the origin, otherwise the registration may be inside-out

2. The model cloud should be in XY plane and facing downward. The existing model in `data` file is qualified.

3. The input scan should be z-axis up and in meters. Otherwise some manual transformations is needed.

4. For now, the input of room scan is in PCD file, it can be easily modified by changing the loading function in *main.cpp*.
